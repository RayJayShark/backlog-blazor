@using BacklogBlazor_Shared.Models
@using BacklogBlazor.Icons

@if (!string.IsNullOrWhiteSpace(_notification))
{
    <div class="bg-red-300 rounded-md">
        @_notification
        <button type="button" @onclick="@(() => _notification = string.Empty)">X</button>
    </div>
}

<EditForm Model="_backlog" OnValidSubmit="SaveBacklog" class="@Class">
    <div class="flex flex-col">
        <div class="flex flex-row text-xl mb-4 items-center">
            <label class="mr-2 font-semibold">Title:</label>
            <InputText @bind-Value="_backlog.Name" placeholder="Enter a title..." class="font-bold border border-slate-300 rounded p-1" />
        </div>
        <div class="flex flex-row text-lg mb-8 items-start">
            <label class="mr-2">Description:</label>
            <InputTextArea @bind-Value="_backlog.Description" placeholder="Enter a description..." rows="2" class="resize-none border border-slate-300 rounded w-3/4 p-1" />
        </div>
    </div>

    <table class="relative isolate z-10 border border-slate-400 border-separate border-spacing-0 bg-slate-50 rounded drop-shadow-md w-full">
        <thead>
        <tr class="divide-x divide-slate-400">
            <th class="border-b border-slate-400 w-6">Rank</th>
            <th class="border-b border-slate-400 w-1/2 min-w-[400px]">Game</th>
            <th class="border-b border-slate-400 w-1/6">Estimated Hours</th>
            <th class="border-b border-slate-400 w-1/6">Current Hours</th>
            <th class="border-b border-slate-400 w-6">Completed?</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var game in _typeaheadGames)
        {
            <tr class="divide-x divide-slate-400">
                <td class="border-b border-slate-400">
                    <div class="flex flex-row justify-evenly">
                        <button type="button"><HeroIcons Icon="HeroIcons.HeroIcon.Bars2_Outline" Class="w-8 h-7 p-1 border rounded border-slate-400 hover:border-slate-600"/></button>
                        <InputNumber TValue="int" class="w-8 font-bold text-center border rounded border-slate-300" Value="@game.Game.Rank" ValueChanged="@(rank => RankChanged(_typeaheadGames.IndexOf(game), rank))" ValueExpression="() => game.Game.Rank" min="1" />
                    </div>
                </td>
                <td class="border-b border-slate-400 px-2 py-1">
                    <BlazoredTypeahead TItem="@Game" TValue="@Game" @bind-Value="@game.Game" SearchMethod="@(searchText => SearchForGames(searchText, game.Game.Rank))"
                                       Debounce="500" placeholder="Search for a game...">
                        <SelectedTemplate Context="select_context">
                            @if (game.Game.Id < 0)
                            {
                                <div>Search for a game...</div>
                            }
                            else
                            {
                                <BacklogGame Game="select_context" />
                            }
                        </SelectedTemplate>
                        <ResultTemplate Context="result_context">
                            <div class="flex flex-col">
                                <div class="flex flex-row items-center">
                                    <div class="group">
                                        <img alt="@(result_context.Name + " Cover")" src="@result_context.GameImageUrl" class="w-8"/>
                                        <div class="fixed flex flex-row items-center drop-shadow-md space-x-0 translate-x-10 -translate-y-[56%] z-50 transition-all duration-300 invisible opacity-0 group-hover:opacity-100 group-hover:visible">
                                            <div class="w-0 h-0 border-y-8 border-y-transparent border-r-[15px] border-r-slate-500 border-opacity-90" />
                                            <div class="p-3 bg-slate-500/90 rounded-md">
                                                <img alt="@(result_context.Name + " Cover Enlarged")" src="@(@result_context.GameImageUrl + "?width=250")"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="font-bold">@result_context.Name</div>
                                </div>
                                <div class="flex flex-row items-center">
                                    <div>Main: @result_context.CompleteMainTime.TotalHours.ToString("0.0")</div>
                                    <div>Main+: @result_context.CompletePlusTime.TotalHours.ToString("0.0")</div>
                                    <div>100%: @result_context.Complete100Time.TotalHours.ToString("0.0")</div>
                                </div>
                            </div>
                        </ResultTemplate>
                    </BlazoredTypeahead>
                </td>
                <td class="border-b border-slate-400 text-center">
                    <InputNumber TValue="double" class="w-20 font-bold text-center border rounded border-slate-300" @bind-Value="@game.Game.EstimateCompleteHours" min="0"/>
                </td>
                <td class="border-b border-slate-400 text-center">
                    <InputNumber TValue="double" class="w-20 font-bold text-center border rounded border-slate-300" @bind-Value="@game.Game.CurrentHours" min="0"/>
                </td>
                <td class="border-b border-slate-400 text-center"><InputCheckbox @bind-Value="@game.Game.Completed"/></td>
            </tr>
        }
        <tr>
            <td colspan="2">
                <button type="button" @onclick="AddGame">Add Game</button>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="isolate">
        <button type="submit" disabled="@_disableSave" class="mt-2 p-2 text-white font-bold drop-shadow-md bg-amber-600 rounded-lg hover:bg-amber-700 disabled:opacity-50 disabled:bg-amber-800"><span class="drop-shadow-lg">Save Backlog</span></button>
        <button type="button" class="mt-2 ml-2 p-1 font-semibold drop-shadow-md border border-slate-500 rounded-lg" @onclick="@(() => DoneEditing.InvokeAsync())">Cancel</button>
    </div>
</EditForm>